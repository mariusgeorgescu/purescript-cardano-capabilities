---
description: Halogen state management and effect patterns
globs: "**/*.purs"
alwaysApply: false
---

# Halogen State & Effects

## State Management

State operations are available in `HalogenM`:

```purescript
H.get        :: HalogenM state ... state
H.gets       :: (state -> a) -> HalogenM state ... a
H.put        :: state -> HalogenM state ... Unit
H.modify     :: (state -> state) -> HalogenM state ... state
H.modify_    :: (state -> state) -> HalogenM state ... Unit
```

- `initialState :: input -> state` must be pure (no effects)
- State changes trigger re-render automatically
- Prefer `modify_` when you don't need the new state

## Effects

Use monad constraints on `m`, not concrete types:

```purescript
handleAction :: forall o m. MonadAff m => Action -> H.HalogenM State Action Slots o m Unit
```

- `liftEffect` — lift `Effect` into `HalogenM`
- `liftAff` — lift `Aff` into `HalogenM`

## Subscriptions

```purescript
sid <- H.subscribe emitter           -- subscribe, auto-cleanup on finalize
H.subscribe' \sid -> ...             -- subscribe with access to own SubscriptionId
H.unsubscribe sid                    -- manual unsubscribe
```

Use `Halogen.Query.Event.eventListener` for DOM event subscriptions:

```purescript
eventListener eventType target (map toAction <<< fromEvent)
```

## Forks

```purescript
fid <- H.fork myProcess              -- start concurrent process
H.kill fid                            -- cancel it
H.join fid                            -- wait for completion
```

Forks are automatically killed when the component finalizes.

## Lifecycle

- `initialize`: runs once on mount, use for setup/subscriptions
- `receive`: runs when parent re-renders with new input
- `finalize`: runs on unmount, use for cleanup
- Subscriptions and forks are auto-cleaned on finalize

## Output

```purescript
H.raise output                       -- emit output message to parent
```

## Querying Children

```purescript
H.tell _slot slotId query             -- tell (fire-and-forget)
H.request _slot slotId query          -- request (returns Maybe a)
H.tellAll _slot query                  -- tell all instances
H.requestAll _slot query               -- request all instances
```
